#!/usr/bin/env node
const stringSimilarity=require("string-similarity");function getSuggestion(e,t){const r=function(e,t){if(!e||!t)return"";let r;if(0===(r=t instanceof Map?Array.from(t.keys()):Object.keys(t)).length)return"";const n=stringSimilarity.findBestMatch(e,r);return n.bestMatch.rating>.1?n.bestMatch.target:""}(e,t);return r?`. Did you mean "${r}"?`:""}const DefaultFormatters={valueFormatters:{},nameFormatters:{camelcase:(e,t)=>(e+!t?"":"."+t).toLowerCase().replace(/(?:^\w|[A-Z]|\b\w)/g,(e,t)=>0===t?e.toLowerCase():e.toUpperCase()).replace(/\s+/g,""),kebabcase:(e,t)=>(e+!t?"":"."+t).match(/[A-Z]{2,}(?=[A-Z][a-z0-9]*|\b)|[A-Z]?[a-z0-9]*|[A-Z]|[0-9]+/g).filter(Boolean).map(e=>e.toLowerCase()).join("-"),uppercase:(e,t)=>(e+!t?"":"."+t).toUpperCase(),lowercase:(e,t)=>(e+!t?"":"."+t).toLowerCase()}},DEFAULT_FILE_HEADER=`\nThis file was automatically generated by Chromatic.\nDo not edit.\nGenerated ${(new Date).toISOString()}\n`,colorName=require("color-name");function clampByte(e){return e<0?0:e>255?255:Math.round(e)}function hueToRgbChannel(e,t,r){return r<0&&(r+=6),r>=6&&(r-=6),r<1?(t-e)*r+e:r<3?t:r<4?(t-e)*(4-r)+e:e}function hslToRgb(e,t,r){e/=60;const n=r<=.5?r*(t+1):r+t-r*t,o=2*r-n;return{r:Math.round(255*hueToRgbChannel(o,n,e+2)),g:Math.round(255*hueToRgbChannel(o,n,e)),b:Math.round(255*hueToRgbChannel(o,n,e-2))}}function rgbToHsl(e,t,r){e/=255,t/=255,r/=255;const n=Math.min(e,t,r),o=Math.max(e,t,r),i=o-n;let a,s;o===n?a=0:e===o?a=(t-r)/i:t===o?a=2+(r-e)/i:r===o&&(a=4+(e-t)/i),(a=Math.min(60*a,360))<0&&(a+=360);const l=(n+o)/2;return{h:a,s:s=o===n?0:l<=.5?i/(o+n):i/(2-o-n),l:l}}function labToRgb(e,t,r){let n=(100*e+16)/116,o=t/500+n,i=n-r/200,a=3.2406*(o=.95047*(o*o*o>.008856?o*o*o:(o-16/116)/7.787))+-1.5372*(n=1*(n*n*n>.008856?n*n*n:(n-16/116)/7.787))+-.4986*(i=1.08883*(i*i*i>.008856?i*i*i:(i-16/116)/7.787)),s=-.9689*o+1.8758*n+.0415*i,l=.0557*o+-.204*n+1.057*i;return a=a>.0031308?1.055*Math.pow(a,1/2.4)-.055:12.92*a,s=s>.0031308?1.055*Math.pow(s,1/2.4)-.055:12.92*s,l=l>.0031308?1.055*Math.pow(l,1/2.4)-.055:12.92*l,{r:clampByte(255*a),g:clampByte(255*s),b:clampByte(255*l)}}function roundTo(e,t){return Math.round(e*Math.pow(10,t)+1e-14)/Math.pow(10,t)}class Percentage{constructor(e){this.value=e}css(){return roundTo(this.value,2)+"%"}type(){return"percentage"}canonicalScalar(){return this.value/100}}class Angle{constructor(e,t){this.value=e,this.unit=t}css(){return roundTo(this.value,2)+this.unit}type(){return"angle"}canonicalScalar(){return asDegree(this)}}class Length{constructor(e,t){this.value=e,this.unit=t}css(){return roundTo(this.value,2)+this.unit}type(){return"length"}canonicalScalar(){return asPx(this)}}class Time{constructor(e,t){this.value=e,this.unit=t}css(){return roundTo(this.value,2)+this.unit}type(){return"time"}canonicalScalar(){return"ms"===this.unit?this.value/1e3:this.value}}class Frequency{constructor(e,t){this.value=e,this.unit=t}css(){return roundTo(this.value,2)+this.unit}type(){return"frequency"}canonicalScalar(){return"khz"===this.unit?1e3*this.value:this.value}}class Float{constructor(e){this.value=e}css(){return Number(this.value).toString()}type(){return"float"}canonicalScalar(){return this.value}}class StringValue{constructor(e){this.value=e}css(e=""){return e+this.value+e}type(){return"string"}canonicalScalar(){return parseFloat(this.value)}}class Color{constructor(e){if("string"==typeof e)if("transparent"===e.toLowerCase())[this.r,this.g,this.b,this.a]=[0,0,0,0],[this.h,this.s,this.l]=[0,0,0];else{const t=function(e){if(!e)return;if("#"!==e[0])return;let t;return(e=e.slice(1)).length<=4?(t={r:parseInt(e[0]+e[0],16),g:parseInt(e[1]+e[1],16),b:parseInt(e[2]+e[2],16)},4===e.length&&(t.a=parseInt(e[3]+e[3],16)/255)):(t={r:parseInt(e[0]+e[1],16),g:parseInt(e[2]+e[3],16),b:parseInt(e[4]+e[5],16)},8===e.length&&(t.a=parseInt(e[6]+e[7],16)/255)),t&&void 0===t.a&&(t.a=1),t}(e)||function(e){const t=colorName[e.toLowerCase()];if(t)return{r:t[0],g:t[1],b:t[2],a:1}}(e);if(!t)throw new Error("Expected a color");Object.assign(this,t),Object.assign(this,rgbToHsl(this.r,this.g,this.b))}else if(Object.assign(this,e),"number"==typeof this.r)Object.assign(this,rgbToHsl(this.r,this.g,this.b));else{if("number"!=typeof this.h)throw new Error("Expected a color");Object.assign(this,hslToRgb(this.h,this.s,this.l))}"number"!=typeof this.a&&(this.a=1)}type(){return"color"}luma(){let e=this.r/255,t=this.g/255,r=this.b/255;return.2126*(e=e<=.03928?e/12.92:Math.pow((e+.055)/1.055,2.4))+.7152*(t=t<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4))+.0722*(r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4))}hex(){let e=((1<<24)+(clampByte(this.r)<<16)+(clampByte(this.g)<<8)+clampByte(this.b)).toString(16).slice(1);return this.a<1&&(e+=("00"+Math.round(255*this.a).toString(16)).slice(-2)),e[0]===e[1]&&e[2]===e[3]&&e[4]===e[5]&&e[6]===e[7]&&(e=e[0]+e[2]+e[4]+(this.a<1?e[6]:"")),"#"+e}rgb(){return`rgb(${this.r}, ${this.g}, ${this.b}${this.a<1?", "+Number(100*this.a).toFixed(0)+"%":""})`}hsl(){return`hsl(${this.h}deg, ${this.s}%, ${this.l}%, ${this.a<1?", "+Number(100*this.a).toFixed(0)+"%":""})`}css(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a?"transparent":this.a<1?this.rgb():this.hex()}canonicalScalar(){return this.luma()}}function isFloat(e){return e instanceof Float}function isPercentage(e){return e instanceof Percentage}function isLength(e){return e instanceof Length}function isString(e){return e instanceof StringValue}function isAngle(e){return e instanceof Angle}function asColor(e){if(!e)return;let t;try{t=new Color(e)}catch(e){t=void 0}return t}function asDecimalByte(e){if(isPercentage(e))return Math.round(255*e.value/100);if(isFloat(e))return Math.round(e.value);throw new Error("Expected a number or percentage")}function asDecimalRatio(e,t){if(isPercentage(e))return e.value/100;if(isFloat(e))return e.value;if(void 0===t)throw new Error("Expected a number or percentage.");return t}function asDegree(e){if(isAngle(e)){if("deg"===e.unit)return e.value;if("rad"===e.unit)return 180*e.value/Math.PI;if("grad"===e.unit)return 180*e.value/200;if("turn"===e.unit)return 360*e.value;throw new Error(`Unknown unit "${e.unit}"`)}if(isFloat(e))return e.value;throw new Error("Expected an angle.")}function asPx(e,t,r){if(isLength(e)){if("px"===e.unit)return e.value;if("cm"===e.unit)return 96*e.value/2.54;if("mm"===e.unit)return 96*e.value/25.4;if("Q"===e.unit)return 96*e.value/2.54/40;if("in"===e.unit)return 96*e.value;if("pc"===e.unit)return 16*e.value;if("pt"===e.unit)return 96*e.value/72;if("rem"===e.unit&&r["base-font-size"])return e.value*r["base-font-size"];throw/^(rem|em|ex|ch|vw|vh|vmin|vmax)/.test(e.unit)?new Error(`Relative unit "${e.unit}" cannot be evaluated. Use an absolute unit (px, pt, etc...)`):new Error(`Unknown unit "${e.unit}"`)}if(isFloat(e))return e.value;if(void 0===t)throw new Error("Expected a length.");return t}function asPercent(e){if(isPercentage(e))return e.value/100;if(isFloat(e))return e.value;throw new Error("Expected a percentage or a float.")}function compareValue(e,t){return t.canonicalScalar()-e.canonicalScalar()}const whiteColor=new Color("#fff"),blackColor=new Color("#000");let functions={};functions={calc:e=>e,rgb:(e,t,r,n)=>new Color({r:asDecimalByte(e),g:asDecimalByte(t),b:asDecimalByte(r),a:asDecimalRatio(n,1)}),hsl:(e,t,r,n)=>new Color({h:asDegree(e),s:asPercent(t),l:asPercent(r),a:asDecimalRatio(n,1)}),hsv:(e,t,r,n)=>{let o=asPercent(t);const i=asPercent(r),a=(2-o)*i/2;return 0!=a&&(o=1==a?0:a<.5?o*i/(2*a):o*i/(2-2*a)),new Color({h:asDegree(e),s:o,l:a,a:asDecimalRatio(n,1)})},hwb:(e,t,r,n)=>new Color(Object.assign({a:asDecimalRatio(n,1)},function(e,t,r){const n=hslToRgb(e,1,.5),o=[];o[0]=n.r/255,o[1]=n.g/255,o[2]=n.b/255;const i=t+r;i>1&&(t=Number((t/i).toFixed(2)),r=Number((r/i).toFixed(2)));for(let e=0;e<3;e++)o[e]*=1-t-r,o[e]+=t,o[e]=Number(255*o[e]);return{r:o[0],g:o[1],b:o[2]}}(asDegree(e),asPercent(t),asPercent(r)))),lab:(e,t,r,n)=>new Color(Object.assign({a:asDecimalRatio(n,1)},labToRgb(asPercent(e),asDecimalRatio(t),asDecimalRatio(r)))),gray:(e,t)=>new Color(Object.assign({a:asDecimalRatio(t,1)},labToRgb(asPercent(e),0,0))),min:(e,t)=>compareValue(e,t)<0?e:t,max:(e,t)=>compareValue(e,t)<0?t:e,clamp:(e,t,r)=>compareValue(t,e)<0?e:compareValue(t,r)>0?r:t,mix:(e,t,r,n)=>{const o=function(e,t){return isString(e)?e.value:"rgb"}(n).toLowerCase(),i=asColor(e);if(!i)return;const a=asColor(t);if(!a)return i;const s=asDecimalRatio(r,.5);let l="number"==typeof a.a?a.a:1;return l+=(("number"==typeof i.a?a.a:1)-l)*s,"rgb"===o?new Color({r:a.r+(i.r-a.r)*s,g:a.g+(i.g-a.g)*s,b:a.b+(i.b-a.b)*s,a:l}):"hsl"===o?new Color({h:a.h+(i.h-a.h)*s,s:a.s+(i.s-a.s)*s,l:a.l+(i.l-a.l)*s,a:l}):void 0},saturate:(e,t)=>{const r=asColor(e);if(r)return new Color({h:r.h,s:r.s+(1-r.s)*asDecimalRatio(t,.1),l:r.l,a:r.a})},desaturate:(e,t)=>{const r=asColor(e);if(r)return new Color({h:r.h,s:r.s-r.s*asDecimalRatio(t,.1),l:r.l,a:r.a})},lighten:(e,t)=>{const r=asColor(e);if(r)return new Color({h:r.h,s:r.s,l:r.l+(1-r.l)*asDecimalRatio(t,.1),a:r.a})},darken:(e,t)=>{const r=asColor(e);if(r)return new Color({h:r.h,s:r.s,l:r.l-r.l*asDecimalRatio(t,.1),a:r.a})},rotateHue:(e,t)=>{const r=asColor(e);if(r)return t&&(isAngle(t)||isFloat(t))?new Color({h:(r.h+asDegree(t)+360)%360,s:r.s,l:r.l,a:r.a}):r},complement:e=>{const t=asColor(e);if(t)return new Color({h:(t.h+180)%360,s:t.s,l:t.l,a:t.a})},contrast:(e,t,r)=>{const n=asColor(e),o=asColor(t)||blackColor,i=asColor(r)||whiteColor;if(!n)throw new Error('"contrast()" requires a color');let a,s;const l=n.luma(),u=o.luma(),c=i.luma();return(a=l>u?(l+.05)/(u+.05):(u+.05)/(l+.05))>(s=l>c?(l+.05)/(c+.05):(c+.05)/(l+.05))?o:i},rgba:(e,t,r,n)=>functions.rgb(e,t,r,n),hsla:(e,t,r,n)=>functions.hsl(e,t,r,n),tint:(e,t)=>functions.mix(whiteColor,e,null!=t?t:new Float(.1)),shade:(e,t)=>functions.mix(blackColor,e,null!=t?t:new Float(.1))};const colorFunctions=["rgb","rgba","hsl","hsla","hwb","grey","lab"];class Stream{constructor(e,t={}){this.s="",this.index=0,this.options={},this.s=e,this.index=0,this.options=t}isEOF(){return this.index>=this.s.length}lookAhead(e){return this.s.slice(this.index,this.index+e)}skipWhiteSpace(){this.match(/^\s*/)}match(e){if("string"==typeof e){if(this.lookAhead(e.length)===e)return this.index+=e.length,e}else{const t=this.s.slice(this.index).match(e);if(t&&t[0])return this.index+=t[0].length,t[1]||!0}}parseUnit(e){if(this.match("%"))return new Percentage(e);let t=this.match(/^(em|ex|ch|rem|vw|vh|vmin|vmax|px|cm|mm|in|pt|pc|Q)/);return t?new Length(e,t):(t=this.match(/^(deg|°|rad|grad|turn)/))?new Angle(e,"°"===t?"deg":t):(t=this.match(/^(ms|s)/))?new Time(e,t):(t=this.match(/^(kHz|Hz)/))?new Frequency(e,t):new Float(e)}parseLiteral(){var e;let t;const r=this.index,n=this.match(/^([0-9]*\.[0-9]+|\.?[0-9]+)/);if(n&&(t=this.parseUnit(parseFloat(n))),!t&&this.match("{")){const r=this.match(/^([a-zA-Z0-9\._-]+)/);r&&(t=(null===(e=this.options)||void 0===e?void 0:e.aliasResolver(r))||new StringValue("{"+r+"}")),this.match("}")}if(!t&&this.match('"')){let e="";for(;'"'!==this.s[this.index]&&!this.isEOF();)"\\"===this.s[this.index]?(e+=this.s[this.index+1],this.index+=2):(e+=this.s[this.index],this.index+=1);if(this.isEOF())throw new Error("Expected '\"'");return this.match('"'),new StringValue(e)}return t||(t=asColor(this.match(/^\s*(#[0-9a-fA-F]{3,8})/))),t||(this.index=r,t=asColor(this.match(/^\s*([a-zA-Z]+)/))),t||(this.index=r),t}parseColorArguments(){const e=[];if(this.skipWhiteSpace(),!this.match("("))return;let t=this.parseExpression();return t&&(e.push(t),this.match(/^(\s*,?|\s+)/)&&(t=this.parseExpression())&&(e.push(t),this.match(/^(\s*,?|\s+)/)&&(t=this.parseExpression())))?(e.push(t),this.match(/^(\s*,?|\s+|\s*\/)/)&&(t=this.parseExpression())?(e.push(t),this.match(")"),e):(this.match(")"),e)):void 0}parseArguments(){if(this.skipWhiteSpace(),!this.match("("))return;const e=[];for(;")"!==this.lookAhead(1)&&!this.isEOF();){const t=this.parseExpression();if(!t)throw new Error("Syntax error in argument list");e.push(t),this.match(/^(\s*,?|\s+)/)}if(this.isEOF())throw new Error('Missing closing ")"');return this.match(")"),e}parseCall(){const e=this.index,t=this.match(/^([a-zA-Z\-]+)/);if(t){if(functions[t]){const e=colorFunctions.includes(t)?this.parseColorArguments():this.parseArguments();if(e)return functions[t](...e);throw new Error(`Syntax error when calling function "${t}"`)}if("("===this.lookAhead(1))throw new Error(`Unknown function "${t}"`+getSuggestion(t,functions))}this.index=e}parseProduct(){const e=this.parseCall()||this.parseGroup()||this.parseLiteral();if(!e)return e;const t=this.index;this.skipWhiteSpace();const r=this.match(/^([*|/])/);if(r){this.skipWhiteSpace();const t=this.parseProduct();if(!t)throw new Error(`Expected right operand after "${r}"`);if(!isFloat(t))return new Float("*"===r?e.canonicalScalar()*t.canonicalScalar():e.canonicalScalar()/t.canonicalScalar());if(isFloat(e))return new Float("*"===r?e.value*t.value:e.value/t.value);if(isPercentage(e))return new Percentage(100*("*"===r?asPercent(e)*t.value:asPercent(e)/t.value));if(isLength(e))return new Length("*"===r?e.value*t.value:e.value/t.value,e.unit);if(isAngle(e))return new Angle("*"===r?e.value*t.value:e.value/t.value,e.unit);if(e instanceof Frequency)return new Frequency("*"===r?e.value*t.value:e.value/t.value,e.unit);if(function(e){return e instanceof Time}(e))return new Time("*"===r?e.value*t.value:e.value/t.value,e.unit);throw new Error("Unexpected operand type")}return this.index=t,e}parseTerm(){const e=this.parseProduct(),t={"+":(e,t)=>e+t,"-":(e,t)=>e-t}[this.match(/^\s*([+\-])\s*/)];if(t){const r=this.parseProduct();if(!r)throw new Error("Expected right operand");if(e){if(isString(e)||isString(r))return new StringValue(t(e.css(),r.css()));if(isPercentage(e)&&isPercentage(r))return new Percentage(100*t(asPercent(e),asPercent(r)));if(isFloat(e)&&isFloat(r))return new Float(t(e.value,r.value));if(isAngle(e)&&isAngle(r))return e.unit===r.unit?new Angle(t(e.value,r.value),e.unit):new Angle(t(asDegree(e),asDegree(r)),"deg");if(isLength(e)&&isLength(r))return e.unit===r.unit?new Length(t(e.value,r.value),e.unit):new Length(t(asPx(e,void 0,this.options),asPx(r,void 0,this.options)),"px");throw new Error(`Operator cannot be applied to "${e.type()}" and "${r.type()}"`)}if(isPercentage(r))return new Percentage(100*t(0,asPercent(r)));if(isFloat(r))return new Float(t(0,r.value));if(isAngle(r))return new Angle(t(0,r.value),r.unit);if(isLength(r))return new Length(t(0,r.value),r.unit);throw new Error(`Operator cannot be applied to "${r.type()}"`)}return e}parseGroup(){let e;if(this.match("(")&&(e=this.parseExpression(),this.skipWhiteSpace(),!this.match(")")))throw new Error('Expected ")"');return e&&isFloat(e)&&(e=this.parseUnit(e.value)),e}parseExpression(){return this.skipWhiteSpace(),this.parseTerm()}}function sanitizePropertyNameForCSS(e){return e.replace(/[^a-zA-Z0-9_-]/g,"-")}function renderSassProperty(e){return`${e.definition.comment?"// "+e.definition.comment+"\n":""}$${sanitizePropertyNameForCSS(e.propertyName)}: ${e.propertyValue} !default;`}const WebFormats={formats:{sass:{ext:".scss",renderFile:e=>(e.header?"/* "+e.header.split("\n").join("\n * ")+"\n */\n\n":"")+e.content,renderProperty:renderSassProperty,renderGroup:function(e){let t="";const r={},n=[];return e.definitions.forEach((e,t)=>{Object.keys(e.value).length>1?Object.keys(e.value).forEach(e=>{r[e]||(r[e]=[]),r[e].push(t)}):n.push(t)}),Object.keys(r).forEach(n=>{const o=r[n].map(t=>(function(e){return`--${sanitizePropertyNameForCSS(e.propertyName)}: ${e.propertyValue};`})(Object.assign(Object.assign({},e),{theme:n,category:"",token:t,definition:e.definitions.get(t),propertyName:t,propertyValue:e.values.get(t+("_"===n?"":"."+n))}))).join("\n\t");t+="_"===n?`:root {\n\t${o}\n}\n`:`body[data-theme="${n}"] {\n\t${o}\n}\n`}),t+=n.map(t=>renderSassProperty(Object.assign(Object.assign({},e),{category:"",theme:"",token:t,definition:e.definitions.get(t),propertyName:t,propertyValue:e.values.get(t)}))).join("\n")}},plist:{ext:".plist",renderFile:e=>'\n<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n\n'+(e.header?"\x3c!-- \n"+e.header+"\n--\x3e\n\n":"")+e.content,renderGroup:e=>`<plist version="1.0"><dict>\n\t${e.properties.join("\n\t")}\n</dict></plist>`,renderProperty:e=>`${e.definition.comment?"\x3c!-- "+e.definition.comment+" --\x3e\n\t":""}<key>${e.propertyName}</key>\n\t<string>${e.propertyValue}</string> `,valueFormatters:["color/plist"]}}},marked=require("marked"),highlight=require("highlight.js"),handlebars=require("handlebars"),fs=require("fs");function renderFragment(e){let t="";const r={colors:[],group:""};return e.themes.forEach(n=>{r.group=1===e.themes.length?"":"_"===n?"Base":n,r.colors=[],e.definitions.forEach((t,o)=>{var i,a;if(t.value[n]){const s=o+("_"===n?"":"."+n),l=e.rawValues.get(s);if("color"===l.type()){const e=l;let n,s=e.luma()>=1?"frame ":"";e.luma()>.42&&(s+="light"),e.a<1&&((n=new Color(e)).a=1),r.colors.push({name:o,def:t.value,value:e.css(),comment:(i=t.comment,null!=i?i:""),cls:s,opaqueColor:null===(a=n)||void 0===a?void 0:a.css()})}}}),t+=handlebars.compile(fs.readFileSync(__dirname+"/templates/html-colors.hbs","utf-8"))(r)}),t&&(t="<h2>Colors</h2>"+t),t}const StyleGuideFormat={formats:{"html/fragment":{ext:".html",renderFile:renderFragment,renderGroup:function(e){return renderFragment(e)},renderProperty:function(e){let t="";return t+=`<b>${e.propertyName}</b>: ${e.propertyValue}`,e.definition.comment&&(t+=`<p>${e.definition.comment}</p>`),e.definition.remarks&&(t+=marked(e.definition.remarks)),t}},html:{extends:"html/fragment",renderFile:function(e){return handlebars.compile(fs.readFileSync(__dirname+"/templates/html-file.hbs","utf-8"))(e)}}}};var _a;marked.setOptions({renderer:new marked.Renderer,highlight:function(e){return highlight.highlightAuto(e).value},pedantic:!1,gfm:!0,breaks:!1,sanitize:!1,smartLists:!0,smartypants:!1,xhtml:!1});const chalk=require("chalk"),ciInfo=require("ci-info");let gUseColor=null!=(_a=process.stdout.isTTY)&&_a&&!ciInfo.isCI;const terminal={useColor:e=>{gUseColor=e},success:(e="")=>(chalk.green("✔︎   "+e),gUseColor?chalk.bold.green("✔︎   "+e):"✔︎   "+e),error:(e="")=>gUseColor?chalk.hex("#fa2040")(chalk.bold("✘   "+e)):"✘   "+e,warning:(e="")=>gUseColor?chalk.hex("#ffcc00")(chalk.bold("⚠️   "+e)):"⚠   "+e,path:(e="")=>gUseColor?chalk.hex("#6ab3ff").italic(e):e,option:(e="")=>gUseColor?chalk.hex("#ffcc00")(e):e,string:(e="")=>gUseColor?chalk.hex("#ffcc00")('"'+chalk.italic(e)+'"'):'"'+e+'"',dim:(e="")=>gUseColor?chalk.hex("#999")(e):e,time:(e=new Date)=>gUseColor?chalk.hex("#d1d7ff")(`[${e.toLocaleTimeString()}]`):"["+e+"]",link:e=>gUseColor?"\n▷   "+chalk.hex("#d1d7ff")("https://github.com/arnog/chromatic/docs/errors/"+e+".md"):"\n▷   https://github.com/arnog/chromatic/docs/errors/"+e+".md"},{cosmiconfigSync:cosmiconfigSync}=require("cosmiconfig"),configParser=cosmiconfigSync("chromatic"),glob=require("glob"),fs$1=require("fs-extra"),path=require("path"),yaml=require("yaml"),json5=require("json5"),resolveFrom=require("resolve-from"),gConfig={};let gThemes,gTokenDefinitions,gTokenValues,gRecursiveEvaluationStack,gProcessedFiles,gWatching=!1,gIgnoreErrors=!1;function error(e){var t;null===(t=gConfig.console)||void 0===t||t.error("\n"+e),gWatching||gIgnoreErrors||process.exit(1)}function log(e){var t;null===(t=gConfig.console)||void 0===t||t.log(e)}function mergeObject(e,t){e!==t&&t&&Object.keys(t).forEach(r=>{Array.isArray(t[r])?(e[r]||(e[r]=[]),e[r]=[...e[r],...t[r]]):"object"==typeof t[r]?(e[r]||(e[r]={}),mergeObject(e[r],t[r])):void 0!==t[r]&&(e[r]=t[r])})}function processPath(e){var t,r;const n=[];if(e=path.resolve(path.normalize(e)),gProcessedFiles.includes(e))return;if(gProcessedFiles.push(e),fs$1.lstatSync(e).isDirectory())return void glob.sync(e+"/**/*."+gConfig.tokenFileExt).forEach(processPath);let o;try{const t=fs$1.readFileSync(e,"utf8");o=/^\.json/.test(path.extname(e))?json5.parse(t):yaml.parse(t)}catch(e){n.push((e.name?e.name+": ":"")+e.message)}if((null===(t=o)||void 0===t?void 0:t.import)&&("string"==typeof o.import&&(o.import=[o.import]),Array.isArray(o.import)?o.import.forEach(t=>{let r=e;try{processPath(r=resolveFrom(path.parse(e).dir,t))}catch(e){n.push("option "+terminal.string(`import: ${t}`)),"MODULE_NOT_FOUND"===e.code?n.push("Module not found."+("./"===t.slice(0,2)?"":`\n    To import as a file, use a relative path: "./${t}"`)):"ENOENT"===e.code?n.push("→ "+terminal.path(r)+"\n    File not found."):n.push(e.message)}}):n.push('Option "import" should be a path or an array of paths')),o&&gConfig.verbose&&(o.imports||o.extends||o.include||o.includes)&&!o.import&&log(terminal.warning()+terminal.path(path.relative("",e))+`\n${terminal.warning("Warning:")} use the \`"import"\` property to import other token files`),null===(r=o)||void 0===r?void 0:r.tokens)try{if("object"!=typeof o.tokens)throw new Error(`The ${terminal.string("tokens")} property should be a key/value map of tokens.`);!function e(t,r,n){if(Array.isArray(n))throw new Error(`The ${terminal.string("tokens")} property is an array. It should be a key/value map of tokens.${terminal.link("tokens-as-array")}`);Object.keys(n).forEach(o=>{var i;const a=(r?r+".":"")+o;if(!/^[a-zA-Z0-9_-]+$/.test(o))throw new Error('Invalid token name "'+a+'": it must only contain digits, letters, "_" and "-"');if(!n[o])throw new Error(`The ${terminal.string(o)} token is null. If using a YAML file, make sure RGB hex values are within quotes.`);try{const r=function(e,t){if("string"!=typeof t&&("object"!=typeof t||!t.value))return;let r={value:{}};return"string"==typeof t?r.value._=t:r=Object.assign({},t),"string"==typeof r.value&&(r.value={_:r.value}),e&&r.value._&&(r.value[e]=r.value._,r.value._=void 0),Object.keys(r.value).forEach(e=>{gThemes.includes(e)||gThemes.push(e)}),r}(null!=(i=t.theme)?i:gConfig.defaultTheme,n[o]);if(r)if(gTokenDefinitions.has(a)){if(r.type&&gTokenDefinitions.get(a).type&&gTokenDefinitions.get(a).type!==r.type)throw new Error('Inconsistent token type: "'+r.type+'" (was "'+gTokenDefinitions.get(a).type+'")');const e=gTokenDefinitions.get(a);mergeObject(e,r),gTokenDefinitions.set(a,e)}else gTokenDefinitions.set(a,r);else e(t,a,n[o])}catch(e){throw new Error(`  ${a}: "${n[o]}"\n    ${e.message}`)}})}(o,"",o.tokens)}catch(e){n.push(e.message)}gConfig.verbose&&0===n.length&&log(terminal.success()+"← "+terminal.path(path.relative("",e))),n.length>0&&error(terminal.error()+terminal.path(path.relative("",e))+"\n    "+n.join("\n    "))}function renderFile$1(e,t){const r=[],n=[];gTokenDefinitions.forEach((e,r)=>{Object.keys(e.value).forEach(e=>{t.themes.includes(e)&&n.push("_"===e?r:r+"."+e)})});const o=function(e,t){if(!t)return;const r=new Map;return e.forEach(e=>{try{r.set(e,t(gTokenValues.get(e)))}catch(t){error(terminal.error(`Error formatting ${terminal.string(gTokenValues.get(e).css())} for the ${terminal.string(e)} token`)+"\n    "+t.message)}}),r}(n,e.valueFormatter);o.forEach((e,t)=>{const r=e.replace(/{[a-zA-Z0-9_-]+}/g,e=>{const t=e.slice(1,-1);return o.has(t)?o.get(t):(error(terminal.error("Unresolved alias.")+`The ${terminal.string(e)} identifier could not be resolved.`+getSuggestion(t,o)),e)});r&&o.set(t,r)});const i=[];return t.themes.forEach(n=>{gTokenDefinitions.forEach((a,s)=>{if(void 0===a.value[n])return;const l=e.nameFormatter(s,n);r.includes(l)&&log(l!==s?terminal.warning("Warning: ")+` the "${s}" token has multiple definitions as "${l}"`:terminal.warning("Warning: ")+` the "${s}" token has multiple definitions`),r.push(l);const u=s+("_"===n?"":"."+n);i.push(e.renderProperty(Object.assign(Object.assign({},t),{theme:n,category:"",properties:i,values:o,token:u,definition:a,propertyName:l,propertyValue:o.get(u)})))})}),e.renderFile(Object.assign(Object.assign({},t),{content:e.renderGroup(Object.assign(Object.assign({},t),{category:"",properties:i,values:o}))}))}function build(e,t){var r,n,o,i,a;n=null===(r=t)||void 0===r?void 0:r.watching,gWatching=null!=n&&n,gThemes=[],gTokenDefinitions=new Map,gTokenValues=new Map,gRecursiveEvaluationStack=[],gProcessedFiles=[],e.forEach(e=>{const t=glob.sync(e);0!==t.length?t.forEach(processPath):error(terminal.error("File not found: ")+terminal.path(e))}),gTokenDefinitions.forEach((e,t)=>{Object.keys(e.value).forEach(r=>{const n=t+("_"===r?"":"."+r);let o;try{(o=function e(t,r){if(!r)return;if(gRecursiveEvaluationStack.includes(t))throw new Error(`Circular definition of the "${t}" token`);gRecursiveEvaluationStack.push(t);const n=function(e,t={}){const r=new Stream(e,t),n=r.parseExpression();if(r.skipWhiteSpace(),r.isEOF())return n}(r,Object.assign(Object.assign({},gConfig),{aliasResolver:r=>{var n,o;if(gTokenValues.has(r))return gTokenValues.get(r);let i;return gTokenDefinitions.has(r)&&(gConfig.defaultTheme&&(i=e(r+"."+gConfig.defaultTheme,null===(n=gTokenDefinitions.get(r))||void 0===n?void 0:n.value[gConfig.defaultTheme])),i||(i=e(r,null===(o=gTokenDefinitions.get(t))||void 0===o?void 0:o.value._))),i}}));return gRecursiveEvaluationStack.pop(),n}(n,e.value[r]))||(o=new StringValue(e.value[r]))}catch(n){error(terminal.error("Syntax error")+` in ${terminal.string(t+': "'+e.value[r])+'"'} \n    `+terminal.dim(n.message)),o=new StringValue(e.value[r])}gTokenValues.set(n,o);const i=o.type();e.type&&i!=e.type&&log(terminal.warning("Warning:")+` Type mismatch. Expected ${terminal.string(e.type)} but got ${terminal.string(i)} for ${terminal.string(n)} token`)})});try{const e=function(e){const t={fileHeader:DEFAULT_FILE_HEADER,renderFilename:function({theme:e,basename:t}){return t+(e?"-"+e:"")},renderGroup:e=>e.properties.join("\n"),renderFile:e=>e.content};if(!gConfig.formats[e])throw new Error(`Unknown format "${e}"`+getSuggestion(e,gConfig.formats));const r=gConfig.formats[e].extends;if("string"==typeof r){if(!gConfig.formats[r])throw new Error(`Unknown format "${r}" in \`${e}.extends\``+getSuggestion(r,gConfig.formats));mergeObject(t,gConfig.formats[r]),mergeObject(t,gConfig.formats[e])}else mergeObject(t,gConfig.formats[e]);if("string"==typeof t.valueFormatter){if(!gConfig.valueFormatters[t.valueFormatter])throw new Error(`Unknown value formatter "${t.valueFormatter}"`+getSuggestion(t.valueFormatter,gConfig.valueFormatters))}else"function"!=typeof t.valueFormatter&&(t.valueFormatter=e=>e.css());if("string"==typeof t.nameFormatter){if(!gConfig.nameFormatters[t.nameFormatter])throw new Error(`Unknown name formatter "${t.nameFormatter}"`+getSuggestion(t.nameFormatter,gConfig.nameFormatters))}else"function"!=typeof t.nameFormatter&&(t.nameFormatter=(e,t)=>e+(t&&"_"!==t?"-"+t:""));return"function"!=typeof t.renderProperty&&(gConfig.verbose&&log(terminal.warning("Warning: ")+` the "${e}" format does not have a \`propertyTemplate\` function`),t.renderProperty=e=>`${e.propertyName}${e.theme?"-"+e.theme:""}: ${e.propertyValue}`),t}(gConfig.outputFormat);e.fileHeader=null!=(o=t.header)?o:e.fileHeader;const r=(null===(i=t)||void 0===i?void 0:i.output)&&path.resolve(t.output),n=function(e,t){var r;const n={};if(!function(){var e;return(null===(e=gConfig.themes)||void 0===e?void 0:e.length)>0&&(gThemes=gThemes.filter(e=>gConfig.themes.includes(e))),gThemes.forEach(e=>{let t=0;gTokenDefinitions.forEach((r,n)=>{void 0!==r.value[e]&&(t+=1)}),0===t&&gThemes.splice(gThemes.indexOf(e),1)}),0!==gThemes.length&&0!==gTokenDefinitions.size||(error(terminal.error("No tokens found.")+"\n    "+`Token files should have a ${terminal.string("tokens")} property`+terminal.link("../guide")),!1)}())return;const o=null!=(r=e&&path.parse(e))?r:{name:"tokens"},i={filepath:"",themes:[],header:t.fileHeader,definitions:gTokenDefinitions,rawValues:gTokenValues,content:""};return gConfig.splitOutput?gThemes.forEach(e=>{i.filepath=path.format({dir:o.dir,name:t.renderFilename({theme:e,basename:o.name}),ext:t.ext}),i.themes=[e],n[i.filepath]=renderFile$1(t,i)}):(i.filepath=path.format({dir:o.dir,name:t.renderFilename({theme:"",basename:o.name}),ext:t.ext}),i.themes=gThemes,n[i.filepath]=renderFile$1(t,i)),n}(r,e);if(n&&!(null===(a=t)||void 0===a?void 0:a.dryRun)){if(!r)return n;if(gConfig.verbose){let e="";1===gThemes.length&&"_"===gThemes[0]||(e=1===gThemes.length?"for theme "+terminal.string(gThemes[0]):"for themes "+gThemes.map(e=>terminal.string(e)).join(", ")),log(`    Writing ${terminal.string(gConfig.outputFormat)} format ${e}`)}Object.keys(n).forEach(e=>{!function(e,t){const r=path.dirname(t);fs$1.existsSync(r)||fs$1.mkdirsSync(r),fs$1.writeFileSync(t,e),(gConfig.verbose||gWatching)&&log(terminal.success()+(gWatching?terminal.time()+" ":"")+"→ "+terminal.path(path.relative("",t)))}(n[e],e)})}}catch(e){error(terminal.error(e.message))}return{}}function chromatic(e,t){var r,n,o,i,a,s,l,u,c,h,g,m,f,p,d,v,y,b,w,C,k,F,x,E,$,T,S,j;"string"==typeof e&&(e=[e]);let O=configParser.search();null==(n=null===(r=O)||void 0===r?void 0:r.isEmpty)||n||mergeObject(gConfig,O.config),(null===(o=t)||void 0===o?void 0:o.config)&&(null==(a=null===(i=O=configParser.load(t.config))||void 0===i?void 0:i.isEmpty)||a||mergeObject(gConfig,O.config)),(null===(s=t)||void 0===s?void 0:s.themes)&&("string"==typeof t.themes?gConfig.themes=t.themes.split(",").map(e=>e.trim()):Array.isArray(t.themes)&&(gConfig.themes=[...t.themes])),u=null===(l=t)||void 0===l?void 0:l.ignoreErrors,gIgnoreErrors=null!=u&&u;const P=[];if("string"==typeof(null===(c=t)||void 0===c?void 0:c.console)?"log"===(null===(h=t)||void 0===h?void 0:h.console)&&(terminal.useColor(!1),gConfig.console={log:e=>{P.push(e)},error:e=>{P.push(e)}}):gConfig.console=null!=(m=null===(g=t)||void 0===g?void 0:g.console)?m:{log:e=>console.error(e),error:e=>console.error(e)},gConfig.themes||(gConfig.themes=[]),gConfig.tokenFileExt=null!=(v=null!=(p=null===(f=t)||void 0===f?void 0:f.tokenFileExt)?p:null===(d=gConfig)||void 0===d?void 0:d.tokenFileExt)?v:"yaml",gConfig.verbose=null!=(C=null!=(b=null===(y=t)||void 0===y?void 0:y.verbose)?b:null===(w=gConfig)||void 0===w?void 0:w.verbose)&&C,gConfig.splitOutput=t.splitOutput,gConfig.outputFormat=null!=(E=null!=(F=null===(k=t)||void 0===k?void 0:k.format)?F:null===(x=gConfig)||void 0===x?void 0:x.outputFormat)?E:"",!gConfig.outputFormat){const e=(null===($=t)||void 0===$?void 0:$.output)&&path.extname(null===(T=t)||void 0===T?void 0:T.output);if(e){const t=Object.keys(gConfig.formats).filter(t=>gConfig.formats[t].ext===e);1===t.length?gConfig.outputFormat=t[0]:gConfig.formats[e.slice(1)]?gConfig.outputFormat=e.slice(1):t.length>1&&error(terminal.error("Ambiguous format. "+`Use ${terminal.option("--format")} to indicate which output format to use.`)+"\n    Did you mean "+terminal.string(t.join(", "))+"?")}gConfig.outputFormat?gConfig.verbose&&log(terminal.warning()+"Setting the format to "+terminal.string(gConfig.outputFormat)+" based on the output file extension. "+`Use ${terminal.option("--format")} to indicate which output format to use.`):(gConfig.outputFormat="yaml",log(terminal.warning("Format not specified.")+` Using "${terminal.option("yaml")}". `+`Use ${terminal.option("--format")} to indicate which output format to use.`))}mergeObject(gConfig.nameFormatters,null===(S=t)||void 0===S?void 0:S.nameFormatters),mergeObject(gConfig.valueFormatters,null===(j=t)||void 0===j?void 0:j.valueFormatters);const D=build(e,t);return P.length>0&&(D.stderr=P.join("\n")),D}mergeObject(gConfig,DefaultFormatters),mergeObject(gConfig,WebFormats),mergeObject(gConfig,{formats:{yaml:{ext:".yaml",renderFile:e=>(e.header?"# "+e.header.split("\n").join("\n# "):"")+"\ntokens:\n"+e.content,renderGroup:e=>"\t"+e.properties.join("\n\t"),renderProperty:e=>`${e.definition.comment?"# "+e.definition.comment+"\n\t":""}${e.propertyName}: "${e.propertyValue}"`},json:{ext:".json",renderFile:e=>e.content,renderGroup:e=>"{\n\t"+e.properties.join(",\n\t")+"\n}",renderProperty:e=>`"${e.propertyName}": "${e.propertyValue}"`}}}),mergeObject(gConfig,StyleGuideFormat),module.exports=chromatic;const chokidar=require("chokidar"),argv=require("yargs").usage("Usage: $0 file(s) [options]").example("$0 ./assets/tokens.yaml -o ./build/tokens.scss","Generate a Sass file from a design tokens YAML file").option("output",{alias:"o",describe:"Save output to path",type:"path"}).normalize("output").option("format",{alias:"f",describe:"Output format: css|sass|js|yaml|json",type:"string"}).option("header",{describe:"Content inserted at the to of the output file",type:"string"}).option("themes",{describe:"Comma separated list of themes to process",type:"string"}).option("split-output",{describe:"If there are multiple themes, output one file per theme. Otherwise the themes are combined in a single file.",type:"boolean",default:!1}).option("token-file-ext",{describe:"Default file extension of token files",type:"string",default:".yaml"}).option("dry-run",{describe:"Validate the token files, attempt to generate the specified file format, but don't output anything",conflicts:"output",type:"boolean"}).option("config",{describe:"Load config file from path",type:"path"}).normalize("config").option("verbose",{describe:"Display additional information during processing",type:"boolean"}).option("no-color",{describe:"Suppress color output in terminal",type:"boolean"}).option("ignore-errors",{alias:"i",describe:"Attempt to continue when an error is encountered",type:"boolean"}).option("watch",{describe:"Watch for changes to the token files and rebuild",type:"boolean"}).help("h").alias("h","help").epilogue("For more information, see https://github.com/arnog/chromatic/docs/guide.md").strict(!0).argv;if(argv._.length<1&&(console.error(terminal.error()+`Expected at least one path to a directory or token file. Use ${terminal.option("--help")} for available options.`),process.exit(1)),argv.watch)chokidar.watch(argv._).on("all",(e,t)=>{chromatic(argv._,Object.assign(Object.assign({},argv),{watching:!0})),console.log(terminal.time()+` ${terminal.dim(argv.$0)}: Waiting for changes... ${terminal.dim("Press Ctrl-C to exit.")}`)});else{const e=chromatic(argv._,argv);console.log(Object.keys(e).map(t=>("stderr"===t?terminal.error():terminal.success())+">>>> "+terminal.path(t)+"\n"+e[t]).join("\n"))}
